<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pop - Prusti user guide</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../install.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../basic.html"><strong aria-hidden="true">3.</strong> Basic Usage</a></li><li class="chapter-item expanded "><a href="../tour/summary.html"><strong aria-hidden="true">4.</strong> Guided Tour</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tour/getting-started.html"><strong aria-hidden="true">4.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../tour/new.html"><strong aria-hidden="true">4.2.</strong> New</a></li><li class="chapter-item expanded "><a href="../tour/push.html"><strong aria-hidden="true">4.3.</strong> Push</a></li><li class="chapter-item expanded "><a href="../tour/pop.html" class="active"><strong aria-hidden="true">4.4.</strong> Pop</a></li><li class="chapter-item expanded "><a href="../tour/testing.html"><strong aria-hidden="true">4.5.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../tour/bad-stack.html"><strong aria-hidden="true">4.6.</strong> A Bad Stack</a></li><li class="chapter-item expanded "><a href="../tour/options.html"><strong aria-hidden="true">4.7.</strong> Options</a></li><li class="chapter-item expanded "><a href="../tour/generics.html"><strong aria-hidden="true">4.8.</strong> Generics</a></li><li class="chapter-item expanded "><a href="../tour/peek.html"><strong aria-hidden="true">4.9.</strong> Peek</a></li><li class="chapter-item expanded "><a href="../tour/final.html"><strong aria-hidden="true">4.10.</strong> Final Code</a></li><li class="chapter-item expanded "><a href="../tour/pledges.html"><strong aria-hidden="true">4.11.</strong> Pledges</a></li></ol></li><li class="chapter-item expanded "><a href="../verify/summary.html"><strong aria-hidden="true">5.</strong> Verification Features</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../verify/panic.html"><strong aria-hidden="true">5.1.</strong> Absence of panics</a></li><li class="chapter-item expanded "><a href="../verify/overflow.html"><strong aria-hidden="true">5.2.</strong> Overflow checks</a></li><li class="chapter-item expanded "><a href="../verify/prepost.html"><strong aria-hidden="true">5.3.</strong> Pre- and postconditions</a></li><li class="chapter-item expanded "><a href="../verify/trusted.html"><strong aria-hidden="true">5.4.</strong> Trusted functions</a></li><li class="chapter-item expanded "><a href="../verify/pure.html"><strong aria-hidden="true">5.5.</strong> Pure functions</a></li><li class="chapter-item expanded "><a href="../verify/predicate.html"><strong aria-hidden="true">5.6.</strong> Predicates</a></li><li class="chapter-item expanded "><a href="../verify/external.html"><strong aria-hidden="true">5.7.</strong> External specifications</a></li><li class="chapter-item expanded "><a href="../verify/loop.html"><strong aria-hidden="true">5.8.</strong> Loop body invariants</a></li><li class="chapter-item expanded "><a href="../verify/pledge.html"><strong aria-hidden="true">5.9.</strong> Pledges</a></li><li class="chapter-item expanded "><a href="../verify/traits.html"><strong aria-hidden="true">5.10.</strong> Trait contract refinement</a></li><li class="chapter-item expanded "><a href="../verify/closure.html"><strong aria-hidden="true">5.11.</strong> Closures</a></li><li class="chapter-item expanded "><a href="../verify/spec_ent.html"><strong aria-hidden="true">5.12.</strong> Specification entailments</a></li><li class="chapter-item expanded "><a href="../verify/type-models.html"><strong aria-hidden="true">5.13.</strong> Type models</a></li></ol></li><li class="chapter-item expanded "><a href="../syntax.html"><strong aria-hidden="true">6.</strong> Specification Syntax</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Prusti user guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pop"><a class="header" href="#pop">Pop</a></h1>
<p><strong>TODO</strong></p>
<pre><code class="language-rust noplaypen">/*
    Chapter 2.5 Pop

    Like push, pop wants to mutate the list. 
    Unlike push, we actually want to return something. 
    But pop also has to deal with a tricky corner case: what if the list is empty?
    To represent this case, we introduce an Option type.
    (Option is actually in the standard library but we write our own to assign specs to functions)
*/

#![feature(box_patterns)]
use prusti_contracts::*;

use std::mem;

// (1) alternative would be to introduce trusted functions again...
pub enum TrustedOption {
    Some(i32),
    None,
}

pub struct List {
    head: Link,
}

enum Link {
    Empty,
    More(Box&lt;Node&gt;),
}

struct Node {
    elem: i32,
    next: Link,
}

#[trusted]
#[requires(src.is_empty())]
#[ensures(dest.is_empty())]
#[ensures(old(dest.len()) == result.len())]
#[ensures(forall(|i: usize| (0 &lt;= i &amp;&amp; i &lt; result.len()) ==&gt; 
                old(dest.lookup(i)) == result.lookup(i)))] 
fn replace(dest: &amp;mut Link, src: Link) -&gt; Link {
    mem::replace(dest, src)
}


impl List {

    #[pure]
    pub fn len(&amp;self) -&gt; usize {
        self.head.len()
    }

    #[pure]
    #[requires(0 &lt;= index &amp;&amp; index &lt; self.len())]
    pub fn lookup(&amp;self, index: usize) -&gt; i32 {
        self.head.lookup(index)
    }

    #[ensures(result.len() == 0)]
    pub fn new() -&gt; Self {
        List {
            head: Link::Empty,
        }
    }

    #[ensures(self.len() == old(self.len()) + 1)] 
    #[ensures(self.lookup(0) == elem)]
    #[ensures(forall(|i: usize| (1 &lt;= i &amp;&amp; i &lt; self.len()) ==&gt;
        old(self.lookup(i-1)) == self.lookup(i)))]
    pub fn push(&amp;mut self, elem: i32) {
        let new_node = Box::new(Node {
            elem: elem,
            next: replace(&amp;mut self.head, Link::Empty),
        });

        self.head = Link::More(new_node);
    }

    // (6) TODO: What would be sensible specifications for pop()?
    // (2): introduce function below
    pub fn pop(&amp;mut self) -&gt; TrustedOption {
        // match self.head { // (2) move out of borrow
        //match &amp;self.head { // (3) use shared reborrow
        match replace(&amp;mut self.head, Link::Empty) { // (5)
            Link::Empty =&gt; {
                TrustedOption::None // (4)
            }
            Link::More(node) =&gt; {
                self.head = node.next; // (4) cannot assign, we just borrowed self.head!
                TrustedOption::Some(node.elem) // (4)
            }
        }
        // unimplemented!() // (2), remove at (4)
    }
}

impl Link {

    #[pure]
    #[ensures(!self.is_empty() ==&gt; result &gt; 0)]
    #[ensures(result &gt;= 0)]
    fn len(&amp;self) -&gt; usize {
        match self {
            Link::Empty =&gt; 0,
            Link::More(box node) =&gt; 1 + node.next.len(),
        }
    }

    #[pure]
    fn is_empty(&amp;self) -&gt; bool {
        match self {
            Link::Empty =&gt; true,
            Link::More(box node) =&gt; false,
        }
    }

    #[pure]
    #[requires(0 &lt;= index &amp;&amp; index &lt; self.len())]
    pub fn lookup(&amp;self, index: usize) -&gt; i32 {
        match self {
            Link::Empty =&gt; unreachable!(),
            Link::More(box node) =&gt; {
                if index == 0 {
                    node.elem
                } else {
                    node.next.lookup(index - 1)
                }
            }
        }
    }

}
</code></pre>
<pre><code class="language-rust noplaypen">#![feature(box_patterns)]
use prusti_contracts::*;

use std::mem;

pub enum TrustedOption {
    Some(i32),
    None,
}

// (3) add implementation for TrustedOption
impl TrustedOption {

    #[pure]
    pub fn is_none(&amp;self) -&gt; bool {
        match self {
            TrustedOption::Some(_) =&gt; false,
            TrustedOption::None =&gt; true,
        }
    }

    #[pure]
    pub fn is_some(&amp;self) -&gt; bool {
        !self.is_none()
    }

    // (6) add method
    #[pure]
    #[requires(self.is_some())] // (7)
    pub fn peek(&amp;self) -&gt; i32 {
        match self {
            TrustedOption::Some(val) =&gt; *val,
            TrustedOption::None =&gt; unreachable!(),
        }
    }

}

pub struct List {
    head: Link,
}

enum Link {
    Empty,
    More(Box&lt;Node&gt;),
}

struct Node {
    elem: i32,
    next: Link,
}

#[trusted]
#[requires(src.is_empty())]
#[ensures(dest.is_empty())]
#[ensures(old(dest.len()) == result.len())]
#[ensures(forall(|i: usize| (0 &lt;= i &amp;&amp; i &lt; result.len()) ==&gt; 
                old(dest.lookup(i)) == result.lookup(i)))] 
fn replace(dest: &amp;mut Link, src: Link) -&gt; Link {
    mem::replace(dest, src)
}


impl List {

    #[pure]
    pub fn len(&amp;self) -&gt; usize {
        self.head.len()
    }

    #[pure]
    #[requires(0 &lt;= index &amp;&amp; index &lt; self.len())]
    pub fn lookup(&amp;self, index: usize) -&gt; i32 {
        self.head.lookup(index)
    }

    #[ensures(result.len() == 0)]
    pub fn new() -&gt; Self {
        List {
            head: Link::Empty,
        }
    }

    #[ensures(self.len() == old(self.len()) + 1)] 
    #[ensures(self.lookup(0) == elem)]
    #[ensures(forall(|i: usize| (1 &lt;= i &amp;&amp; i &lt; self.len()) ==&gt;
        old(self.lookup(i-1)) == self.lookup(i)))]
    pub fn push(&amp;mut self, elem: i32) {
        let new_node = Box::new(Node {
            elem: elem,
            next: replace(&amp;mut self.head, Link::Empty),
        });

        self.head = Link::More(new_node);
    }

    // (1) TODO: What would be sensible specifications for pop()?
    //      a) empty list means we return None
    //      b) non-empty list means we return Some(_)
    //      c) lengths are changed correctly
    //      d) the returned value is the first element of the old list
    //      e) all elements except the first one remain unchanged

    // (2) spec a/b) we could add explicit matches but that would be silly
    #[ensures(old(self.len()) == 0 ==&gt; result.is_none())] // (2) spec a)

    #[ensures(old(self.len()) &gt; 0 ==&gt; result.is_some())]  // (2) spec b)
    // (4) specification c)
    #[ensures(old(self.len()) == 0 ==&gt; self.len() == 0)]  // (4) empty lists remain empty
    #[ensures(old(self.len()) &gt; 0 ==&gt; self.len() == old(self.len()-1))] // (4) non-empty lists are 1 smaller
    // (5) specification d)
    #[ensures(old(self.len()) &gt; 0 ==&gt; result.peek() == old(self.lookup(0)))] // (5)
    // (6) specification e)
    #[ensures(old(self.len()) &gt; 0 ==&gt; // (6)
    forall(|i: usize| (0 &lt;= i &amp;&amp; i &lt; self.len()) ==&gt; // (6)
        old(self.lookup(i+1)) == self.lookup(i)))] // (6)
    pub fn pop(&amp;mut self) -&gt; TrustedOption {
        match replace(&amp;mut self.head, Link::Empty) {
            Link::Empty =&gt; {
                TrustedOption::None
            }
            Link::More(node) =&gt; {
                self.head = node.next;
                TrustedOption::Some(node.elem)
            }
        }
    }
}

impl Link {

    #[pure]
    #[ensures(!self.is_empty() ==&gt; result &gt; 0)]
    #[ensures(result &gt;= 0)]
    fn len(&amp;self) -&gt; usize {
        match self {
            Link::Empty =&gt; 0,
            Link::More(box node) =&gt; 1 + node.next.len(),
        }
    }

    #[pure]
    fn is_empty(&amp;self) -&gt; bool {
        match self {
            Link::Empty =&gt; true,
            Link::More(box node) =&gt; false,
        }
    }

    #[pure]
    #[requires(0 &lt;= index &amp;&amp; index &lt; self.len())]
    pub fn lookup(&amp;self, index: usize) -&gt; i32 {
        match self {
            Link::Empty =&gt; unreachable!(),
            Link::More(box node) =&gt; {
                if index == 0 {
                    node.elem
                } else {
                    node.next.lookup(index - 1)
                }
            }
        }
    }

}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../tour/push.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../tour/testing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tour/push.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../tour/testing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
